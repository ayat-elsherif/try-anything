import videojs from"video.js";function factory(e,r){var t,l,n,o,i,s=[],a=!1,d=!1,c=!1,f=!1,u=!1,v=!1,p=!1,m=!1,h=!1,g="undefined",y=0,j=e.$(".vjs-tech");videojs.isAd=!1;var C,k,T,b=videojs.dom,N=e.el(),_=.1,S=videojs.browser;function I(e){return"[object Array]"===Object.prototype.toString.call(e)}var M=function(e,r){try{return e.querySelector(r)}catch(e){return!1}},O=function(e,r,t){var l=document.createElement(e);void 0!==r&&""!==r&&(l.className=r);return l};function A(){return e.duration()===1/0||"8"===S.IOS_VERSION&&0===e.duration()}if(!I(r)){var H=r,L=0;if(H.src&&H.href&&"undefined"!==H.offset&&H.src.length>5){L=0;try{L=H.offset.indexOf("%")}catch(e){}L>0&&A()||((r=[])[0]=H)}}if(I(r))for(var P=0,x=0;x<r.length;x++){var E=r[x];if(E.src&&"undefined"!==E.offset){E.loaded=!1;P=0;try{P=s[x].offset.indexOf("%")}catch(e){}P>0&&d||s.push(E)}}e.ready(function(){C=M(e.el_,".vjs-control-bar");k=M(e.el_,".vjs-loading-spinner");if(s.length>0){l=O("a","roll-blocker vjs-hidden");o=O("div","vjs-roll-controls vjs-hidden");var r='<div class="roll-btn roll-play-pause roll-paused"></div><div class="roll-countdown">'+e.localize("Advertisement")+'</div><div class="roll-btn roll-fscreen roll-non-fullscreen"></div>';r+='<div class="roll-btn roll-mute roll-non-muted"></div>';o.innerHTML=r;e.el_.appendChild(l);e.el_.appendChild(o);function H(e){var r=e.el().querySelector(".vjs-tech"),t={ended:e.ended(),src:e.currentSrc(),currentTime:e.currentTime(),type:e.currentType(),currentSource:e.currentSource(),playing:!e.paused(),suppressedTracks:L(e)};t.ended&&(t.currentTime=e.duration()+1);r&&(t.style=r.getAttribute("style"));return t}function L(e){var r=e.remoteTextTracks?e.remoteTextTracks():[];r&&I(r.tracks_)&&(r=r.tracks_);I(r)||(r=[]);var t=[];r.forEach(function(e){t.push({track:e,mode:e.mode});e.mode="disabled"});return t}function P(){i.suppressedTracks.forEach(function(e){e.track.mode=e.mode})}function x(e,r){var t=e.el().querySelector(".vjs-tech");"style"in i&&t.setAttribute("style",i.style||"");e.one("contentloadedmetadata",P);var l=function(){if(i.ended)videojs.isAd=!1;else if(d)e.play();else{e.currentTime(i.currentTime);e.play()}};t.poster="";e.src(i.currentSource);e.load();P();l()}e.vroll.reset=function(){p=!1;f=!1;b.removeClass(N,"vjs-ad-playing");e.one("playing",function(e){for(var r=0;r<s.length;r++)s[r].loaded=!1})};if(0===parseInt(s[0].offset,10)&&!0!==m)if(e.offline);else{m=!0;e.isPreroll=!0;var E=e.muted();e.muted(!0);e.$(".vjs-tech").style.opacity="0"}e.on("loadeddata",function(){if(e.isOffline)p=!1;else if(!p){p=!0;if(!(d=A()))var r=e.duration();if(s.length>0&&!0!==u){u=!0;for(var m=0;m<s.length;m++)if(!d){var I=0;try{I=s[m].offset.indexOf("%",0)}catch(e){}if(I>0){var L=parseInt(s[m].offset,10);s[m].offset=100===L?r:r*(L/100)}else s[m].offset=parseInt(s[m].offset,10)}}if(s.length>0){e.on("timeupdate",function(){videojs.dom.hasClass(N,"vjs-has-started")&&!0!==c&&!0!==e.isOffline&&!0!==d&&$(e.currentTime())});function P(){if(c){clearTimeout(T);h=!1}else{$(_+=.5);T=setTimeout(P,500)}}if(A()){e.on("pause",function(e){clearTimeout(T);h=!1});e.on("playing",function(r){if(videojs.dom.hasClass(N,"vjs-has-started")&&!0!==a&&s.length>0&&!0!==e.isOffline&&!0!==h){h=!0;T=setTimeout(P,500)}})}function $(r){if(!a&&!c)for(var t=r,d=0;d<s.length;d++){var u=s[d];if(t>=u.offset&&!0!==a&&!0!==s[d].loaded){a=!0;s[d].loaded=!0;g=s[d];f=!0;var v={src:u.src,type:u.type};i=H(e);e.src(v);b.addClass(C,"vjs-abs-hidden");l.className="roll-blocker";void 0!==u.href?l.innerHTML='<a href="'+g.href+'" target="_blank"></a>':l.innerHTML="";o.className="vjs-roll-controls";c=!0;b.addClass(N,"vjs-ad-playing");if(!0!==E){e.muted(!1);b.addClass(U,"roll-non-muted");b.removeClass(U,"roll-muted")}setTimeout(function(){e.load();e.play();e.one("loadeddata",q)},200);try{e._el.removeChild(n)}catch(e){}(y=g.skip>0?parseInt(g.skip,10):0)>0&&B()}}}var q=function(r){e.$(".vjs-tech").style.opacity="1";e.$(".vjs-poster").style.opacity="0";e.off("loadeddata",q);e.on("timeupdate",G);e.one("ended",R);e.one("error",V);e.one("playing",J)};l.onclick=function(){e.trigger("vroll",{id:g.id,action:"clicked"})};var w=function(){return e.paused()},z=function(){return e.muted()};function D(){try{t.removeChild(n)}catch(e){}try{e.el_.removeChild(n)}catch(e){}var r=g.offset;g.loaded=!0;g=void 0;var d=!1;b.addClass(N,"vjs-has-started");for(var u=0;u<s.length;u++){if(s[u].offset===r&&!0!==s[u].loaded){a=!0;c=!0;s[u].loaded=!0;videojs.isAd=!0;b.addClass(N,"vjs-ad-playing");g=s[u];f=!0;var v={src:g.src,type:g.type};e.src(v);b.addClass(C,"vjs-abs-hidden");l.className="roll-blocker";void 0!==g.href?l.innerHTML='<a href="'+g.href+'" target="_blank"></a>':l.innerHTML="";o.className="vjs-roll-controls";setTimeout(function(){e.load();e.play();e.one("loadeddata",q)},200);try{e._el.removeChild(n)}catch(e){}(y=g.skip>0?parseInt(g.skip,10):0)>0&&B();d=!0}if(d)break}if(!0!==d){e.off("timeupdate",G);e.off("ended",R);e.off("error",V);e.off("playing",J);a=!1;f=!1;c=!1;l.className="roll-blocker vjs-hidden";b.removeClass(C,"vjs-abs-hidden");b.removeClass(C,"vjs-hidden");o.className="vjs-roll-controls vjs-hidden";b.addClass(k,"vjs-abs-hidden");b.addClass(N,"vjs-has-started");j.poster="";x(e,i);e.$(".vjs-tech").style.opacity="1";e.muted(!1);videojs.isAd=!1;b.removeClass(N,"vjs-ad-playing")}}function F(r,t){var l=t-(r=r>0?r:0),i=Math.floor(l/60),s=Math.floor(l%60);s.toString().length<2&&(s="0"+s);if(!isNaN(i)&&!isNaN(s)){M(o,".roll-countdown").innerHTML=e.localize("Advertisement")+"<span>"+i+":"+s+"</span>";if(y>0){var a=Math.ceil(y-r),d="";if(a>0)if(!0!==v){v=!0;d+="<span>"+e.localize("Skip Ad in")+' <i id="time_left">'+a+"</i></span>";n.innerHTML=d}else try{document.getElementById("time_left").innerHTML=a}catch(e){}else if(v&&"roll-skip-button enabled"!==n.className){n.innerHTML="<span>"+e.localize("Skip Now!")+'</span><i class="circle"></i>';n.className="roll-skip-button enabled"}}}}function B(){try{t.removeChild(n)}catch(e){}try{N.removeChild(n)}catch(e){}n=O("div","roll-skip-button");v=!1;e.el_.appendChild(n);n.onclick=function(e){r(e)};function r(r){r.preventDefault();r.stopPropagation();if((" "+n.className+" ").indexOf(" enabled ")>=0){e.trigger("vroll",{id:g.id,action:"skipped"});D()}}}function R(){if(a){e.trigger("vroll",{id:g.id,action:"completed"});D()}}function V(){if(a){e.trigger("vroll",{id:g.id,action:"error"});D();f=!1}}function G(){if(a){if(!w()){var r=e.duration();F(e.currentTime(),r)}}}function J(){if(a&&f){e.trigger("vroll",{id:g.id,action:"start"});f=!1}}var K=M(o,".roll-play-pause");K.onclick=function(e){Q(e)};K.ontouchstart=function(e){Q(e)};function Q(r){r.preventDefault();r.stopImmediatePropagation();if(w()){e.play();b.removeClass(K,"roll-playing");b.addClass(K,"roll-paused");e.trigger("vroll",{id:g.id,action:"resumed"})}else{e.pause();b.removeClass(K,"roll-paused");b.addClass(K,"roll-playing");e.trigger("vroll",{id:g.id,action:"paused"})}}var U=M(o,".roll-mute");U.onclick=function(e){W(e)};U.ontouchstart=function(e){W(e)};e.muted()&&b.addClass(U,"roll-muted");b.removeClass(U,"roll-non-muted");function W(r){r.preventDefault();r.stopImmediatePropagation();if(z()){e.muted(!1);b.addClass(U,"roll-non-muted");b.removeClass(U,"roll-muted")}else{e.muted(!0);b.addClass(U,"roll-muted");b.removeClass(U,"roll-non-muted")}}var X=M(o,".roll-fscreen");X.onclick=function(e){Y(e)};X.ontouchstart=function(e){Y(e)};function Y(r){r.preventDefault();r.stopImmediatePropagation();if(e.isFullscreen())e.exitFullscreen();else{if(S.IS_IPHONE&&c)return;e.requestFullscreen()}}e.on("fullscreenchange",function(){if(e.isFullscreen()){b.addClass(X,"roll-fullscreen");b.removeClass(X,"roll-non-fullscreen")}else{b.addClass(X,"roll-non-fullscreen");b.removeClass(X,"roll-fullscreen")}})}}})}})}var registerPlugin=videojs.registerPlugin||videojs.plugin,plugin=function(e){this.ready(function(){factory(this,e)})};registerPlugin("vroll",plugin);export default plugin;