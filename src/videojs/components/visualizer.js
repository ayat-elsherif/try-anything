import videojs from"video.js";var defaults={video:!1,color1:"#ffcc00",color2:"#ff0000",capsColor:"#fff",caps:!1,bottom:0,width:50,height:50,f_play:!1};const registerPlugin=videojs.registerPlugin||videojs.plugin,onPlayerReady=(e,t)=>{var i=videojs.browser.IS_IPHONE,o=videojs.browser.IS_POD,n=t;if(function(){if("undefined"!=typeof window){window.AudioContext=window.AudioContext||window.webkitAudioContext;return!!window.AudioContext}}()&&!0!==i&&!0!==o){var r,a,l,d,s,c,f,u,h=!0,w=new WeakMap,v=50,m=0;t.height>0&&t.height<=100&&(v=t.height);t.bottom>0&&(m=t.bottom+"%");var p=".vjs-visualizer{position:absolute;left:0;padding:0 10px;bottom:"+m+";width:100%;height:"+v+"%;pointer-events:none;}",g=document.head||document.getElementsByTagName("head")[0],y=document.createElement("style");y.type="text/css";y.appendChild(document.createTextNode(p));g.appendChild(y);(l=document.createElement("canvas")).className="vjs-visualizer";l.id="visualizer";e.el().insertBefore(l,e.controlBar.el_);e.on("loadeddata",function(){r=!1;var t=e.currentType();console.log("TYPE:"+t);r=t.indexOf("audio")>-1;n.f_play=!1;n.video&&(r=!0)});function A(){var t=e.$(".vjs-tech");try{void 0===a&&(a=new AudioContext);if(w.has(t))f=w.get(t);else{f=a.createMediaElementSource(t);w.set(t,f)}u=a.createAnalyser();l.width=l.offsetWidth;l.height=e.el().offsetHeight;c=l.getContext("2d");f.connect(u);u.connect(a.destination)}catch(e){}}e.on("playing",function(){if(!n.f_play){void 0!==e.currentSource().av&&(h=!1);var t=e.el().querySelector(".vjs-background-bar");n.f_play=!0;if(r&&h&&t){A();function i(e,t){e=e.replace("#","");var i=parseInt(3===e.length?e.slice(0,1).repeat(2):e.slice(0,2),16),o=parseInt(3===e.length?e.slice(1,2).repeat(2):e.slice(2,4),16),n=parseInt(3===e.length?e.slice(2,3).repeat(2):e.slice(4,6),16);return t?"rgba("+i+", "+o+", "+n+", "+t+")":"rgb("+i+", "+o+", "+n+")"}n.color1.indexOf("#")<0&&(n.color1="#"+n.color1);n.color2.indexOf("#")<0&&(n.color2="#"+n.color2);var o="#ffcc00",a="#ff0000",f="#fff",w=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i;w.test(n.capsColor)&&(f=n.capsColor);w.test(n.color1)&&(o=n.color1);w.test(n.color2)&&(a=n.color2);var v=i(o),m=i(a),p=i(o,.2),g=[];function y(){if(r){if("VIDEO"===e.$(".vjs-tech").nodeName){var t=e.el().querySelector(".vjs-background-bar");t&&(t.style.height="10%")}u.fftSize=256;d=u.frequencyBinCount;l.width=e.el().offsetWidth-20;var i=l.width/d*1.2;i<6&&(i=6);var o,a=1;l.width<500&&(a=2);"undefined"!=typeof window&&(window.RequestAnimationFrame=window.requestAnimationFrame(y)||window.msRequestAnimationFrame(y)||window.mozRequestAnimationFrame(y)||window.webkitRequestAnimationFrame(y));var h=0;s=new Uint8Array(d);u.getByteFrequencyData(s);c.clearRect(0,0,l.width,l.height);for(var w=0;w<d;w+=a){w=parseInt(w,10);o=s[w];if(h+i<l.width){var A=c.createLinearGradient(0,0,0,.5*l.height);A.addColorStop(1,v);A.addColorStop(.5,m);A.addColorStop(0,m);var R=l.height/1.5-o,b=l.height/1.5;c.fillStyle=A;c.fillRect(h,R,i,o);if(n.caps)if(g[h]){c.fillStyle=f;if(R<g[h]){g[h]=R;R!==b&&c.fillRect(h,R-6,i,3)}else{g[h]=g[h]+1;g[h]<b&&c.fillRect(h,g[h]-6,i,3)}}else g[h]=R;c.fillStyle=p;c.fillRect(h,l.height/1.5,i,o/2);h+=i+4}}}else try{c.clearRect(0,0,l.width,l.height)}catch(e){}}"undefined"!=typeof window&&(window.RequestAnimationFrame=window.requestAnimationFrame(y)||window.msRequestAnimationFrame(y)||window.mozRequestAnimationFrame(y)||window.webkitRequestAnimationFrame(y))}}})}},visualizer=function(e){this.ready(()=>{onPlayerReady(this,videojs.mergeOptions(defaults,e))})};registerPlugin("visualizer",visualizer);visualizer.VERSION="1.0";export default visualizer;